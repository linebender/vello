env:
  # We aim to always test with the latest stable Rust toolchain, however we pin to a specific
  # version like 1.70. Note that we only specify MAJOR.MINOR and not PATCH so that bugfixes still
  # come automatically. If the version specified here is no longer the latest stable version,
  # then please feel free to submit a PR that adjusts it along with the potential clippy fixes.
  RUST_STABLE_VER: "1.76" # In quotes because otherwise (e.g.) 1.70 would be interpreted as 1.7

name: Web Demo Release

on:
  push:
    branches:
      - main

jobs:
  rustfmt:
    runs-on: ubuntu-latest
    name: cargo fmt
    steps:
      - uses: actions/checkout@v4

      - name: install stable toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_STABLE_VER }}
          targets: wasm32-unknown-unknown

      - name: install wasm-bindgen
        uses: jetli/wasm-bindgen-action@v0.2.0
        with:
          version: 'latest'

      - name: build (wasm)
        run: cargo build -p with_winit --bin with_winit_bin --release --target wasm32-unknown-unknown
        env:
          RUSTFLAGS: '--cfg=web_sys_unstable_apis'

      - name: package wasm
        run: |
          mkdir public
          wasm-bindgen --target web --out-dir public target/wasm32-unknown-unknown/release/with_winit_bin.wasm --no-typescript
          cat << EOF > public/index.html
            <html>
              <title>Vello Web Demo</title>
              <meta content=no-cache http-equiv=Cache-control>
              <meta content=-1 http-equiv=Expires>
              <script type=module>import initSync from"/vello/with_winit_bin.js";initSync(`/vello/with_winit_bin_bg.wasm`);</script>
              <link as=fetch crossorigin href=/vello/with_winit_bin_bg.wasm rel=preload type=application/wasm>
              <link crossorigin href=/vello/with_winit_bin.js rel=modulepreload>
              </head>
              <body>
                <style>
                  body {
                    margin: 0;
                    padding: 0;
                  }
                </style>
              </body>
            </html>
          EOF

      - name: deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
